{% extends "base.html" %}

{% block title %}Moderator{% endblock %}

{% block extra_head %}
<style>
  .flag-icon {
    display: inline-block;
    padding: 2px 6px;
    margin: 0 2px;
    font-size: 0.75rem;
    border-radius: 3px;
    background: #6c757d;
    color: white;
  }
  .flag-offensive { background: #dc3545; }
  .flag-british { background: #0d6efd; }
  .flag-us { background: #198754; }
  .flag-old { background: #6c757d; }
  .flag-informal { background: #ffc107; color: #000; }
  .imgwrap {
    position: relative;
    cursor: pointer;
    transition: opacity 0.2s;
  }
  .imgwrap:hover {
    opacity: 0.8;
  }
  .imgwrap.removing {
    opacity: 0.3;
  }
  .loading {
    text-align: center;
    padding: 40px;
    color: #6c757d;
  }
  .spinner-border {
    width: 3rem;
    height: 3rem;
  }
</style>
{% endblock %}

{% block content %}
  <div class="container mt-3">
    <h1>Moderator</h1>
    <p>Review generated definition images and remove any that are inappropriate or incorrect. Click an image to delete it.</p>

    <div id="loading" class="loading">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2">Loading definitions...</p>
    </div>

    <div id="definitions-list" class="list-group" style="display: none;">
      <!-- Definitions will be populated via AJAX -->
    </div>

    <script>
      // Fetch and display definitions via AJAX
      async function loadDefinitions() {
        try {
          const response = await fetch('/moderator/api/definitions');
          const data = await response.json();
          
          document.getElementById('loading').style.display = 'none';
          const listContainer = document.getElementById('definitions-list');
          listContainer.style.display = 'block';
          
          if (!data.definitions || data.definitions.length === 0) {
            listContainer.innerHTML = '<div class="alert alert-info">No definitions with images found.</div>';
            return;
          }
          
          data.definitions.forEach(def => {
            const item = createDefinitionItem(def);
            listContainer.appendChild(item);
          });
          
        } catch (error) {
          console.error('Error loading definitions:', error);
          document.getElementById('loading').innerHTML = 
            '<div class="alert alert-danger">Error loading definitions. Please refresh the page.</div>';
        }
      }
      
      function createDefinitionItem(def) {
        const item = document.createElement('div');
        item.className = 'list-group-item';
        
        // Build flags HTML
        let flagsHtml = '';
        if (def.flags.offensive) flagsHtml += '<span class="flag-icon flag-offensive" title="Offensive">‚ö†Ô∏è Offensive</span>';
        if (def.flags.british) flagsHtml += '<span class="flag-icon flag-british" title="British English">üá¨üáß British</span>';
        if (def.flags.us) flagsHtml += '<span class="flag-icon flag-us" title="US English">üá∫üá∏ US</span>';
        if (def.flags.old_fashioned) flagsHtml += '<span class="flag-icon flag-old" title="Old Fashioned">üìú Old</span>';
        if (def.flags.informal) flagsHtml += '<span class="flag-icon flag-informal" title="Informal">üí¨ Informal</span>';
        
        // Build header
        const funcLabel = def.functional_label ? ` <em class="text-muted">(${def.functional_label})</em>` : '';
        item.innerHTML = `
          <div class="d-flex w-100 justify-content-between align-items-start mb-2">
            <div>
              <h5 class="mb-1">
                <strong>${escapeHtml(def.word)}</strong>${funcLabel}
                ${flagsHtml}
              </h5>
              <small class="text-muted">UUID: ${def.uuid} | Def ID: ${def.id}</small>
            </div>
          </div>
          <p class="mb-2">${escapeHtml(def.definition)}</p>
          <div class="images">
            ${def.images.map(filename => `
              <div class="imgwrap d-inline-block m-1" data-filename="${escapeHtml(filename)}">
                <img class="thumb img-thumbnail" 
                     src="/moderator/asset/${encodeURIComponent(filename)}" 
                     alt="${escapeHtml(filename)}" 
                     title="Click to delete: ${escapeHtml(filename)}"
                     style="width:120px;height:120px;object-fit:cover;"/>
              </div>
            `).join('')}
          </div>
        `;
        
        return item;
      }
      
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
      
      async function deleteImage(el) {
        const wrap = el.closest('.imgwrap');
        if (!wrap) return;
        const file = wrap.dataset.filename;
        if (!file) return;
        
        if (!confirm(`Delete image: ${file}?`)) {
          return;
        }
        
        try {
          wrap.classList.add('removing');
          const resp = await fetch(`/moderator/asset/${encodeURIComponent(file)}`, { method: 'DELETE' });
          const data = await resp.json().catch(() => ({}));
          if (!resp.ok || !data.ok) {
            console.error('Delete failed', data);
            alert('Failed to delete image: ' + (data.error || 'Unknown error'));
            wrap.classList.remove('removing');
            return;
          }
          // Remove after transition
          setTimeout(() => {
            wrap.remove();
            // Check if parent list item has no more images
            const listItem = wrap.closest('.list-group-item');
            if (listItem && !listItem.querySelector('.imgwrap')) {
              listItem.style.opacity = '0.5';
              listItem.querySelector('.images').innerHTML = '<em class="text-muted">All images deleted</em>';
            }
          }, 220);
        } catch (e) {
          console.error('Error deleting', e);
          alert('Error deleting image');
          wrap.classList.remove('removing');
        }
      }
      
      // Event delegation for image clicks
      document.addEventListener('click', (e) => {
        const img = e.target.closest('img.thumb');
        if (img) {
          e.preventDefault();
          deleteImage(img);
        }
      });
      
      // Load definitions on page load
      document.addEventListener('DOMContentLoaded', loadDefinitions);
    </script>
  </div>
{% endblock %}
