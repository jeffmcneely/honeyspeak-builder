{% extends "base.html" %}

{% block title %}Migration Tools - Honeyspeak Builder{% endblock %}

{% block content %}
<div class="container mt-4">
  <h1>üîÑ Migration Tools</h1>
  <p class="lead">Tools for reorganizing assets and updating database schema.</p>
  <p class="text-muted">Database Backend: <strong>{{ backend }}</strong></p>
  
  <div class="row mt-4">
    <div class="col-md-12">
      <div class="card mb-3">
        <div class="card-body">
          <h5 class="card-title">üìù Update Word Levels</h5>
          <p class="card-text">
            Upload a wordlist to update CEFR levels for existing words in the database.
            Uses the same format as dictionary building (e.g., "apple n.", "run v.").
          </p>
          
          <form id="updateLevelsForm">
            <div class="mb-3 form-check">
              <input type="checkbox" class="form-check-input" id="markUnknownFirst" name="mark_unknown_first">
              <label class="form-check-label" for="markUnknownFirst">
                <strong>Mark all words as 'z1' first</strong>
                <br>
                <small class="text-muted">‚ö†Ô∏è This will reset all existing level values before updating from the wordlist</small>
              </label>
            </div>
            
            <div class="mb-3">
              <label for="wordlistFile" class="form-label">Wordlist File</label>
              <input type="file" class="form-control" id="wordlistFile" name="wordlist" required accept=".txt">
              <small class="form-text text-muted">Format: "word function_label" (e.g., "apple n." or "run v.")</small>
            </div>
            
            <div class="mb-3">
              <label for="cefrLevel" class="form-label">CEFR Level</label>
              <select class="form-select" id="cefrLevel" name="level" required>
                <option value="a1">A1</option>
                <option value="a2">A2</option>
                <option value="b1">B1</option>
                <option value="b2">B2</option>
                <option value="c1">C1</option>
                <option value="c2">C2</option>
              </select>
            </div>
            
            <button type="submit" class="btn btn-primary">
              <span class="spinner-border spinner-border-sm d-none" role="status" id="updateSpinner"></span>
              Update Levels
            </button>
          </form>
          
          <div id="updateResult" class="mt-3"></div>
        </div>
      </div>
    </div>
  </div>
  
  <hr class="my-4">
  <h3>Asset Management</h3>
  
  <div class="row mt-4">
    <div class="col-md-6">
      <div class="card mb-3">
        <div class="card-body">
          <h5 class="card-title">üìÅ Relocate Files</h5>
          <p class="card-text">
            Reorganize assets_hires directory by moving files into subdirectories:
          </p>
          <ul>
            <li><strong>image/</strong> - All image_* files</li>
            <li><strong>audio/</strong> - All *.aac audio files</li>
            <li><strong>temp/</strong> - Temporary workspace</li>
          </ul>
          <button id="relocateFilesBtn" class="btn btn-primary">
            <span class="spinner-border spinner-border-sm d-none" role="status" id="relocateSpinner"></span>
            Relocate Files
          </button>
          <div id="relocateResult" class="mt-3"></div>
        </div>
      </div>
    </div>
    
    <div class="col-md-6">
      <div class="card mb-3">
        <div class="card-body">
          <h5 class="card-title">üóëÔ∏è Delete Conceptual Images</h5>
          <p class="card-text">
            Remove all image assets for non-noun/verb words (adjectives, adverbs, etc.).
            Conceptual words should not have visual representations.
          </p>
          <p class="text-warning"><strong>‚ö†Ô∏è This action cannot be undone.</strong></p>
          <button id="deleteConceptualImagesBtn" class="btn btn-danger">
            <span class="spinner-border spinner-border-sm d-none" role="status" id="deleteSpinner"></span>
            Delete Conceptual Images
          </button>
          <div id="deleteResult" class="mt-3"></div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="row mt-4">
    <div class="col-md-12">
      <div class="card mb-3">
        <div class="card-body">
          <h5 class="card-title">üßπ Clean Packages</h5>
          <p class="card-text">
            Delete all packaging artifacts to prepare for a fresh package build:
          </p>
          <ul>
            <li><strong>package*</strong> files in assets directory</li>
            <li><strong>db.sqlite</strong> in assets directory</li>
            <li>All files in <strong>assets/temp/*</strong></li>
          </ul>
          <p class="text-warning"><strong>‚ö†Ô∏è This will remove all packaged files. You'll need to rebuild packages after this.</strong></p>
          <button id="cleanPackagesBtn" class="btn btn-warning">
            <span class="spinner-border spinner-border-sm d-none" role="status" id="cleanSpinner"></span>
            Clean Packages
          </button>
          <div id="cleanResult" class="mt-3"></div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
$(document).ready(function() {
  // Update word levels handler
  $('#updateLevelsForm').on('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const level = $('#cefrLevel').val();
    const markUnknownFirst = $('#markUnknownFirst').is(':checked');
    
    let confirmMsg = `Update word levels to ${level.toUpperCase()}?\n\n`;
    if (markUnknownFirst) {
      confirmMsg += '‚ö†Ô∏è This will first mark ALL words as "z1", then update matching words from the wordlist.\n\n';
    } else {
      confirmMsg += 'This will update matching words in the database.\n\n';
    }
    confirmMsg += 'Continue?';
    
    if (!confirm(confirmMsg)) {
      return;
    }
    
    const $btn = $(this).find('button[type="submit"]');
    const $spinner = $('#updateSpinner');
    const $result = $('#updateResult');
    
    // Disable button and show spinner
    $btn.prop('disabled', true);
    $spinner.removeClass('d-none');
    $result.html('');
    
    // If mark_unknown_first is checked, call that endpoint first
    if (markUnknownFirst) {
      $result.html('<div class="alert alert-info">Step 1/2: Marking all words as unknown...</div>');
      
      $.ajax({
        url: '/migration/mark_unknown',
        method: 'POST',
        success: function(markResponse) {
          if (markResponse.ok) {
            $result.html(`
              <div class="alert alert-success">
                <strong>Step 1/2 Complete:</strong> Marked all words as unknown<br>
                Task ID: <code>${markResponse.task_id}</code>
              </div>
              <div class="alert alert-info">Step 2/2: Updating word levels from wordlist...</div>
            `);
            
            // Now proceed with the level update
            proceedWithLevelUpdate(formData, level, $btn, $spinner, $result);
          } else {
            $btn.prop('disabled', false);
            $spinner.addClass('d-none');
            $result.html(`
              <div class="alert alert-danger">
                <strong>Error in Step 1:</strong> ${markResponse.error || 'Unknown error'}
              </div>
            `);
          }
        },
        error: function(xhr) {
          $btn.prop('disabled', false);
          $spinner.addClass('d-none');
          
          let errorMsg = 'Request failed';
          try {
            const response = JSON.parse(xhr.responseText);
            errorMsg = response.error || errorMsg;
          } catch (e) {}
          
          $result.html(`
            <div class="alert alert-danger">
              <strong>Error in Step 1:</strong> ${errorMsg}
            </div>
          `);
        }
      });
    } else {
      // Skip mark_unknown step, go straight to level update
      proceedWithLevelUpdate(formData, level, $btn, $spinner, $result);
    }
  });
  
  // Helper function to update levels
  function proceedWithLevelUpdate(formData, level, $btn, $spinner, $result) {
    $.ajax({
      url: '/migration/update_levels',
      method: 'POST',
      data: formData,
      processData: false,
      contentType: false,
      success: function(response) {
        $btn.prop('disabled', false);
        $spinner.addClass('d-none');
        
        if (response.ok) {
          const currentHtml = $result.html();
          $result.html(currentHtml + `
            <div class="alert alert-success">
              <strong>Task Started!</strong><br>
              Processing ${response.words_count} words to level <strong>${response.level.toUpperCase()}</strong><br>
              Task ID: <code>${response.task_id}</code><br>
              <small>Check <a href="/celery_status">Celery Status</a> or <a href="/task_status/${response.task_id}">Task Status</a> for progress.</small>
            </div>
          `);
        } else {
          const currentHtml = $result.html();
          $result.html(currentHtml + `
            <div class="alert alert-danger">
              <strong>Error:</strong> ${response.error || 'Unknown error'}
            </div>
          `);
        }
      },
      error: function(xhr) {
        $btn.prop('disabled', false);
        $spinner.addClass('d-none');
        
        let errorMsg = 'Request failed';
        try {
          const response = JSON.parse(xhr.responseText);
          errorMsg = response.error || errorMsg;
        } catch (e) {}
        
        const currentHtml = $result.html();
        $result.html(currentHtml + `
          <div class="alert alert-danger">
            <strong>Error:</strong> ${errorMsg}
          </div>
        `);
      }
    });
  }
  
  // Relocate Files handler
  $('#relocateFilesBtn').on('click', function(e) {
    e.preventDefault();
    
    if (!confirm('Relocate files in assets_hires?\n\nThis will:\n- Move image_* to image/\n- Move *.aac to audio/\n- Create temp/ directory\n\nContinue?')) {
      return;
    }
    
    const $btn = $(this);
    const $spinner = $('#relocateSpinner');
    const $result = $('#relocateResult');
    
    // Disable button and show spinner
    $btn.prop('disabled', true);
    $spinner.removeClass('d-none');
    $result.html('');
    
    $.ajax({
      url: '/moderator/api/relocate-files',
      method: 'POST',
      success: function(response) {
        $btn.prop('disabled', false);
        $spinner.addClass('d-none');
        
        if (response.ok) {
          $result.html(`
            <div class="alert alert-success">
              <strong>Success!</strong> Files relocated.
              <ul class="mb-0 mt-2">
                <li>Images moved: ${response.images_moved}</li>
                <li>Audio moved: ${response.audio_moved}</li>
              </ul>
            </div>
          `);
        } else {
          $result.html(`
            <div class="alert alert-danger">
              <strong>Error:</strong> ${response.error || 'Unknown error'}
            </div>
          `);
        }
      },
      error: function(xhr) {
        $btn.prop('disabled', false);
        $spinner.addClass('d-none');
        
        let errorMsg = 'Request failed';
        try {
          const response = JSON.parse(xhr.responseText);
          errorMsg = response.error || errorMsg;
        } catch (e) {}
        
        $result.html(`
          <div class="alert alert-danger">
            <strong>Error:</strong> ${errorMsg}
          </div>
        `);
      }
    });
  });
  
  // Delete Conceptual Images handler
  $('#deleteConceptualImagesBtn').on('click', function(e) {
    e.preventDefault();
    
    if (!confirm('Delete all image assets for non-noun/verb words?\n\nThis will remove images for adjectives, adverbs, and other conceptual words.\n\n‚ö†Ô∏è This action cannot be undone.\n\nContinue?')) {
      return;
    }
    
    const $btn = $(this);
    const $spinner = $('#deleteSpinner');
    const $result = $('#deleteResult');
    
    // Disable button and show spinner
    $btn.prop('disabled', true);
    $spinner.removeClass('d-none');
    $result.html('');
    
    $.ajax({
      url: '/moderator/api/delete-conceptual-images',
      method: 'POST',
      success: function(response) {
        $btn.prop('disabled', false);
        $spinner.addClass('d-none');
        
        if (response.ok) {
          $result.html(`
            <div class="alert alert-success">
              <strong>Task Started!</strong><br>
              Task ID: <code>${response.task_id}</code><br>
              <small>Check <a href="/celery_status">Celery Status</a> for progress.</small>
            </div>
          `);
        } else {
          $result.html(`
            <div class="alert alert-danger">
              <strong>Error:</strong> ${response.error || 'Unknown error'}
            </div>
          `);
        }
      },
      error: function(xhr) {
        $btn.prop('disabled', false);
        $spinner.addClass('d-none');
        
        let errorMsg = 'Request failed';
        try {
          const response = JSON.parse(xhr.responseText);
          errorMsg = response.error || errorMsg;
        } catch (e) {}
        
        $result.html(`
          <div class="alert alert-danger">
            <strong>Error:</strong> ${errorMsg}
          </div>
        `);
      }
    });
  });
  
  // Clean Packages handler
  $('#cleanPackagesBtn').on('click', function(e) {
    e.preventDefault();
    
    if (!confirm('Clean all packaging artifacts?\n\nThis will delete:\n- All package* files\n- db.sqlite in assets directory\n- All files in assets/temp/*\n\n‚ö†Ô∏è You will need to rebuild packages after this.\n\nContinue?')) {
      return;
    }
    
    const $btn = $(this);
    const $spinner = $('#cleanSpinner');
    const $result = $('#cleanResult');
    
    // Disable button and show spinner
    $btn.prop('disabled', true);
    $spinner.removeClass('d-none');
    $result.html('');
    
    $.ajax({
      url: '/moderator/api/clean-packages',
      method: 'POST',
      success: function(response) {
        $btn.prop('disabled', false);
        $spinner.addClass('d-none');
        
        if (response.ok) {
          $result.html(`
            <div class="alert alert-success">
              <strong>Task Started!</strong><br>
              Task ID: <code>${response.task_id}</code><br>
              <small>Check <a href="/celery_status">Celery Status</a> for progress.</small>
            </div>
          `);
        } else {
          $result.html(`
            <div class="alert alert-danger">
              <strong>Error:</strong> ${response.error || 'Unknown error'}
            </div>
          `);
        }
      },
      error: function(xhr) {
        $btn.prop('disabled', false);
        $spinner.addClass('d-none');
        
        let errorMsg = 'Request failed';
        try {
          const response = JSON.parse(xhr.responseText);
          errorMsg = response.error || errorMsg;
        } catch (e) {}
        
        $result.html(`
          <div class="alert alert-danger">
            <strong>Error:</strong> ${errorMsg}
          </div>
        `);
      }
    });
  });
});
</script>
{% endblock %}
